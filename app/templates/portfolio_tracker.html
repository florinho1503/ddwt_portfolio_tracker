{% extends "base.html" %}

{% block title %}Portfolio Tracker{% endblock %}

{% block content %}
    <ul class="breadcrumb">
        <li><a href="../">Home</a></li>
        <li> Portfolio</li>
    </ul>
    <div class="row1">
        <h1>Your Portfolio Tracker</h1>
    </div>
    <div class="row1">
        <div style="display: flex; align-items: flex-start; gap: 20px;">
            {% if plot_path %}
            <div>
                <h2>Portfolio Performance</h2>
                <img src="{{ url_for('static', filename=plot_path) }}" alt="Portfolio Performance Graph" style="max-width: 100%; height: auto;">
            </div>
            {% endif %}

            {% if holdings %}
            <div>
                <h2>Current Holdings (by Percentage)</h2>
                <canvas id="holdingsPieChart" width="300" height="300"></canvas>
            </div>
            {% endif %}
        </div>
    </div>
    {% if holdings %}
    <div class ="row1"></div>
        <h2>Live Portfolio Value (updates every 5s)</h2>
        <p id="liveValue" class="live-value">${{ live_value }}</p>
    </div>
    {% else %}
    <p>No holdings available.</p>
    {% endif %}

    <div style="text-align: center; margin-top: 20px;">
        <button class="add-transaction-btn" onclick="location.href='/add_transaction'">Add Transaction</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        {% if holdings %}
        const holdingsData = {{ holdings|tojson }};
        const labels = Object.keys(holdingsData);
        const data = Object.values(holdingsData);

        const ctx = document.getElementById('holdingsPieChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Holdings by Value (%)',
                    data: data,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    }
                }
            }
        });
        {% endif %}

        // Track the previous live value
        let previousLiveValue = {{ live_value }};

        // Refresh live portfolio value every 5 seconds
        function refreshLiveValue() {
            fetch('{{ url_for("get_live_value") }}')
                .then(response => response.json())
                .then(data => {
                    const liveValueElement = document.getElementById('liveValue');
                    const newValue = data.live_value;

                    // Update the displayed value
                    liveValueElement.textContent = `$${newValue}`;

                    // Compare with previous value and apply styles
                    if (newValue > previousLiveValue) {
                        liveValueElement.classList.add('flash-green');
                        liveValueElement.classList.remove('flash-red');
                    } else if (newValue < previousLiveValue) {
                        liveValueElement.classList.add('flash-red');
                        liveValueElement.classList.remove('flash-green');
                    }

                    // Remove the animation class after 1 second
                    setTimeout(() => {
                        liveValueElement.classList.remove('flash-green', 'flash-red');
                    }, 1000);

                    // Update the previous live value
                    previousLiveValue = newValue;
                })
                .catch(error => console.error('Error fetching live value:', error));
        }

        // Refresh live value every 5 seconds
        setInterval(refreshLiveValue, 5000);
    </script>
{% endblock %}
